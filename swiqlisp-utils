# -*- mode:shell-script; page-delimiter: "^#" -*-

# Copyright © 2011 Sebastian D. Tennant <sdt@sebyte.me>
#
# This file is part of swiQlisp — site-wide Quicklisp.
#
# swiQlisp is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# swiQlisp is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# swiQlisp.  If not, see <http://www.gnu.org/licenses/>

# Commentary:
#
#  This is the swiQlisp utilities file, loaded at startup by each swiQlisp
#  script.


#-----------------------------------------------------------------------------
y-or-n-with-default-answer () {
    # $1 = question, $2 = optional default answer (y or n)
    if test -z "$2" -o "$2" = "y" -o "$2" = "Y"; then default=y; fi
    if test "$default" = "y"; then
	prompt_string="[Y/n]"
    else
	default=n; prompt_string="[y/N]"
    fi

    read -p "$1 $prompt_string? " ans

    if test -z "$ans"; then ans=$default; fi; }

check_help () {
    if test "$1" = "-h" -o "$1" = "--help"; then
	echo "$1"; exit 0;
    fi; }

check_root_privileges () {
    if test $(id -u) -ne 0; then
	echo "Root privileges required."
	exit 1
    fi; }

ensure_no_trailing_slash () {
    if test ${1: -1} = /; then echo -n ${1:0: -1}
    else echo -n $1
    fi ; }

# ensure_trailing_slash () {
#     if test ${1: -1} = /; then echo -n $1
#     else echo -n $1/
#     fi ; }

check_sysusr_home () {
    # remove trailing slash in SYSUSR_HOME (if any)
    SYSUSR_HOME=$(ensure_no_trailing_slash $SYSUSR_HOME)
    # check that parent directory exists
    if test ! -d $(dirname $SYSUSR_HOME); then
	echo "Warning: $(dirname $SYSUSR_HOME) not found."
    fi
    # debugging
    if test $DEBUG = on; then
	echo "debug: SYSUSR=$SYSUSR"
	echo "debug: SYSUSR_HOME=$SYSUSR_HOME";
    fi; }

check_lisp_and_setup_accordingly () {
    if test ! -x "$LISP"; then
	echo "$LISP not found in filesystem. Aborting. (Tip: use absolute paths)."
	exit 1
    fi
    # set implementation specific values
    case $LISP in
	sbcl|/bin/sbcl|/usr/bin/sbcl|/usr/local/bin/sbcl)
	    source swiqlisp-sbcl ;;
        # add other lisps here
	*)
	    echo "Unknown lisp implementation: $LISP. Aborting."
	    exit 1 ;;
    esac
    # debugging
    if test $DEBUG = on; then
	echo "debug: LISP=$LISP"
	echo "debug: SYSINIT_FILE=$SYSINIT_FILE"
    fi ; }
