#!/bin/bash
# -*- page-delimiter: "^#" -*-

# Copyright © 2011 Sebastian D. Tennant <sdt@sebyte.me>
#
# This file is part of swiQlisp — site-wide Quicklisp.
#
# swiQlisp is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# swiQlisp is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# swiQlisp.  If not, see <http://www.gnu.org/licenses/>

# Commentary:
#
#  This script (swiqlisp-install) is the site-wide Quicklisp installation tool,
#  typically only used once.
#
#  Use the script 'swiqlisp' to manage your site-wide Quicklisp installation on
#  a day-to-day basis.

#-----------------------------------------------------------------------------
source swiqlisp.rc
source swiqlisp-utils
help_requested "Usage: sudo ./swiqlisp-install"
check_root
swiqlisp_paths
lisp_setup


#-----------------------------------------------------------------------------
# prepare swiqlisp installation directory
mkdir -p $SWIQLISP_DIR
QUICKLISP_DIR=$SWIQLISP_DIR/quicklisp
QUICKSTART_FILE=$SWIQLISP_DIR/quicklisp.lisp
LISP_ERRLOG=$SWIQLISP_DIR/lisp-error.log

if test -d $QUICKLISP_DIR; then
    echo "Site-wide Quicklisp is already installed."
    exit 1
fi
# fetch Quicklisp quickstart file (overwrites any existing quickstart file)
if test $VERBOSE = on; then
    wget -O $QUICKSTART_FILE http://beta.quicklisp.org/quicklisp.lisp
else
    echo "Fetching Quicklisp quickstart file from quicklisp.org ..."
    wget -q -O $QUICKSTART_FILE http://beta.quicklisp.org/quicklisp.lisp
fi
# setup installed-systems files
touch $SWIQLISP_DIR/installed-systems.current
touch $SWIQLISP_DIR/installed-systems.added
touch $SWIQLISP_DIR/installed-systems.removed
touch $SWIQLISP_DIR/installed-systems.old
# setup installed-systems dir
mkdir -p $SWIQLISP_DIR/installed-systems


#-----------------------------------------------------------------------------
# install Quicklisp
LISP_COMMAND='$SU -c "$INVOC $COMMANDS"'
# INVOC is defined in swiqlisp-<impl> files
EVAL="'(quicklisp-quickstart:install :path \"$SWIQLISP_PATHNAME\")'"
if test $VERBOSE = on; then
    COMMANDS="$load $QUICKSTART_FILE $eval $EVAL $quit 2>$LISP_ERRLOG"
else
    echo "Installing Quicklisp site-wide ..."
    COMMANDS="$load $QUICKSTART_FILE $eval $EVAL $quit 1>/dev/null 2>$LISP_ERRLOG"
fi
if test $DEBUG = on; then
    # write the command for visual inspection
    eval echo $LISP_COMMAND; fi
# go!
eval $LISP_COMMAND
# check for errors
if test -s $LISP_ERRLOG; then
    echo "An error occurred.  See $LISP_ERRLOG for details."
    exit 1
else # success
    rm $LISP_ERRLOG # empty
    rm $QUICKSTART_FILE
    echo "Site-wide Quicklisp installed under $SWIQLISP_DIR."
fi

#-----------------------------------------------------------------------------
# add/remove the swiQlisp stanza
source swiqlisp-stanza

#-----------------------------------------------------------------------------
echo "swiQlisp successfully installed."
